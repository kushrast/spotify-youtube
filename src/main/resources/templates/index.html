<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
  <title>Spotify Youtube Sync</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<body>
<p th:text="'Hello!'" />
<a href="/authenticate_spotify" id="authenticate">Authenticate Me!</a>
<button id="sync">Start syncing</button>
</body>
<script th:inline="javascript">
  var syncRequest = null;
  var playbackData = null;

  function onLoad() {
    $( "#sync" ).hide();
    var error = [[${error}]];
    if (error != "" && error != null) {
      console.log("encountered error: " + error);
      alert(error);
    };

    var refresh_token = Cookies.get("refresh_token");
    if (refresh_token != null && refresh_token != "") {
      $( "#authenticate" ).hide();
      $( "#sync" ).show();
    }
  }

  function sync() {
    var spotifyUri = playbackData != null ? playbackData["spotifyUri"] : "";
    var oldYouTubeId = playbackData != null ? playbackData["youTubeId"] : "";
    $.getJSON({
      url: "/update",
      data: {
        "spotifyUri": spotifyUri
      }
    })
      .done(function( data ) {
        console.log( "data:", data);
        playbackData = data;

        $("#youtubePlayer").remove();

        var autoplay = data["currentPlaying"] == "true" ? "autoplay" : "";
        var autoplayNum = data["currentPlaying"] == "true" ? 1 : 0;
        var progress = data["progressSeconds"];
        var youTubeId = data["youTubeId"] != "" ? data["youTubeId"] : oldYouTubeId;

        if (youTubeId == "") {
          alert("encountered error while getting latest state from server.");
        } else {
          $("body").append('<iframe width="1280" height="720" id="youtubePlayer" src="https://www.youtube.com/embed/'+youTubeId+'?start='+progress+'&mute=1&autoplay='+autoplayNum+'" frameborder="0" allow="accelerometer; '+autoplay+'; encrypted-media; gyroscope;picture-in-picture" allowfullscreen></iframe>');
          }
      });
    }

  function toggleSync(e) {
    if (syncRequest != null) {
      $("#sync").html("Start syncing");
      clearInterval(syncRequest);
      syncRequest = null;
    } else {
      $("#sync").html("Stop sync");
      sync();
      syncRequest = setInterval(sync, 15000);
    }
  }
  $("#sync").on("click", toggleSync);

  onLoad();
</script>
</html>